<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Maintenance Log</title>
    <link rel="stylesheet" href="styles.css">
    <script src="javascript/common.js"></script>
</head>
<body>
    <div class="container">
        <h2><img src="images/icon.svg" alt="Vehicle Maintenance" style="width: 32px; height: 32px; vertical-align: middle;"> Vehicle Maintenance Log Entry</h2>
        <form id="maintenanceForm">
            <h2>Vehicle Information</h2>
            <div class="form-group">
                <label for="vehicleYear">Year:</label>
                <input type="text" id="vehicleYear" readonly>
            </div>
            <div class="form-group">
                <label for="vehicleMake">Make:</label>
                <input type="text" id="vehicleMake" readonly>
            </div>
            <div class="form-group">
                <label for="vehicleModel">Model:</label>
                <input type="text" id="vehicleModel" readonly>
            </div>
            <div class="form-group">
                <label for="vehicleVIN">VIN (Vehicle Identification Number):</label>
                <input type="text" id="vehicleVIN" readonly>
            </div>

            <hr>

            <h2>Maintenance Details</h2>
            <div class="form-group">
                <label for="maintenanceDate">Date of Service:</label>
                <input type="date" id="maintenanceDate" required>
            </div>
            <div class="form-group">
                <label for="mileage">Mileage / Hours at Service:</label>
                <div class="inline-group">
                    <input type="number" id="mileage" required min="0" step="1">
                    <select id="mileageUnit">
                        <option value="miles" selected>Miles</option>
                        <option value="kilometers">Kilometers</option>
                        <option value="hours">Hours</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="serviceType">Type of Service:</label>
                <select id="serviceType" required>
                    <option value="">-- Select Service Type --</option>
                    <option value="Oil Change">Oil Change</option>
                    <option value="Tire Rotation">Tire Rotation</option>
                    <option value="Brake Service">Brake Service</option>
                    <option value="General Inspection">General Inspection</option>
                    <option value="Other Repair">Other Repair</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="workPerformed">Work Performed:</label>
                <textarea id="workPerformed" placeholder="Detailed description of the services rendered, e.g., Flushed transmission fluid, Replaced front brake pads and rotors."></textarea>
            </div>

            <div class="form-group">
                <label>Parts Used (Qty | Part Name | Part # | Brand | Cost (Each)):</label>
                <div id="partsContainer">
                    </div>
                <button type="button" id="addPart">âž• Add Part</button>
            </div>

            <div class="form-group">
                <label for="nextServiceDueMileage">Next Service Due (Mileage/Hours):</label>
                <div class="inline-group">
                    <input type="number" id="nextServiceDueMileage" placeholder="E.g., 5000" min="0" step="1">
                    <select id="nextServiceMileageUnit">
                        <option value="miles" selected>Miles</option>
                        <option value="kilometers">Kilometers</option>
                        <option value="hours">Hours</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="nextServiceDueDate">Next Service Due (Date):</label>
                <input type="date" id="nextServiceDueDate">
            </div>

            <div class="buttons">
                <button type="button" id="generateReport">Generate Report & Print</button>
                <button type="button" id="resetForm">Reset Form</button>
            </div>

        </form>

        <div id="reportOutput">
            <h2>ðŸ“„ Maintenance Log Report</h2>
        </div>
    </div>

    <script>
        // --- Vanilla JavaScript for Functionality ---

        // Attach Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            // Attach click listeners *after* the DOM content is loaded
            document.getElementById('generateReport').addEventListener('click', generateAndPrintReport);
            document.getElementById('resetForm').addEventListener('click', resetMaintenanceForm);
            document.getElementById('addPart').addEventListener('click', addPartEntry);
            document.getElementById('serviceType').addEventListener('change', handleServiceTypeChange);
            
            // Add the first part entry automatically
            initializeForm();
        });

        function handleServiceTypeChange(event) {
            const serviceType = event.target.value;
            const workPerformedField = document.getElementById('workPerformed');
            
            // Only pre-fill if the field is currently empty
            if (!workPerformedField.value.trim()) {
                let defaultText = '';
                
                switch(serviceType) {
                    case 'Oil Change':
                        defaultText = `- Drained engine oil
- Replaced engine oil filter
- Refilled engine oil`;
                        break;
                    case 'Tire Rotation':
                        defaultText = '- Rotated tires according to manufacturer\'s recommended pattern';
                        break;
                    case 'Brake Service':
                        defaultText = '';
                        break;
                    case 'General Inspection':
                        defaultText = '';
                        break;
                    case 'Other Repair':
                        defaultText = '';
                        break;
                    default:
                        defaultText = '';
                }
                
                workPerformedField.value = defaultText;
            }
        }

        function addPartEntry() {
            const container = document.getElementById('partsContainer');
            
            const partDiv = document.createElement('div');
            partDiv.className = 'part-entry';
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.placeholder = 'Qty';
            quantityInput.className = 'part-quantity';
            quantityInput.min = '1';
            quantityInput.value = '1';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Part Name';
            nameInput.className = 'part-name';
            
            const numberInput = document.createElement('input');
            numberInput.type = 'text';
            numberInput.placeholder = 'Part #';
            numberInput.className = 'part-number';

            const brandInput = document.createElement('input');
            brandInput.type = 'text';
            brandInput.placeholder = 'Brand';
            brandInput.className = 'part-brand';

            const costInput = document.createElement('input');
            costInput.type = 'number';
            costInput.placeholder = 'Cost ($)';
            costInput.className = 'part-cost';
            costInput.min = '0';
            costInput.step = '0.01';

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.textContent = 'X';
            removeButton.onclick = () => container.removeChild(partDiv);

            partDiv.appendChild(quantityInput);
            partDiv.appendChild(nameInput);
            partDiv.appendChild(numberInput);
            partDiv.appendChild(brandInput);
            partDiv.appendChild(costInput);
            partDiv.appendChild(removeButton);

            container.appendChild(partDiv);
        }

        function getPartsData() {
            const parts = [];
            const partEntries = document.querySelectorAll('.part-entry');
            let totalCost = 0;
            
            partEntries.forEach(entry => {
                // Use a default of 0 for quantity and cost if input is empty or invalid
                const quantity = parseFloat(entry.querySelector('.part-quantity').value) || 0;
                const name = entry.querySelector('.part-name').value.trim();
                const number = entry.querySelector('.part-number').value.trim();
                const brand = entry.querySelector('.part-brand').value.trim();
                const cost = parseFloat(entry.querySelector('.part-cost').value) || 0;

                // Only record parts that have meaningful data (name, number, or brand)
                if (name || number || brand) {
                    const lineCost = quantity * cost;
                    totalCost += lineCost;

                    parts.push({ quantity, name, number, brand, cost, lineCost });
                }
            });
            
            return { parts, totalCost };
        }
        
        function generateAndPrintReport() {
            const form = document.getElementById('maintenanceForm');
            // Check HTML5 validity *before* proceeding
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const reportOutput = document.getElementById('reportOutput');
            const { parts, totalCost } = getPartsData();
            
            // 1. Gather fixed form data
            const mileageValue = document.getElementById('mileage').value;
            const mileageUnit = document.getElementById('mileageUnit').value;
            const nextServiceMileage = document.getElementById('nextServiceDueMileage').value.trim();
            const nextServiceMileageUnit = document.getElementById('nextServiceMileageUnit').value;
            const nextServiceDate = document.getElementById('nextServiceDueDate').value;
            
            // Build the "Next Service Due" string
            let nextServiceDue = '';
            if (nextServiceMileage) {
                nextServiceDue = `${formatNumberWithCommas(nextServiceMileage)} ${nextServiceMileageUnit}`;
            }
            if (nextServiceDate) {
                if (nextServiceDue) {
                    nextServiceDue += ` or ${nextServiceDate}`;
                } else {
                    nextServiceDue = nextServiceDate;
                }
            }
            if (!nextServiceDue) {
                nextServiceDue = 'TBD';
            }
            
            const fixedData = {
                'Vehicle Year': document.getElementById('vehicleYear').value || 'N/A',
                'Vehicle Make': document.getElementById('vehicleMake').value || 'N/A',
                'Vehicle Model': document.getElementById('vehicleModel').value || 'N/A',
                'VIN': document.getElementById('vehicleVIN').value || 'N/A',
                'Date of Service': document.getElementById('maintenanceDate').value,
                'Mileage / Hours': `${formatNumberWithCommas(mileageValue)} ${mileageUnit}`,
                'Type of Service': document.getElementById('serviceType').value,
                'Work Performed': document.getElementById('workPerformed').value.trim() || 'No detailed work description provided.',
                'Next Service Due': nextServiceDue
            };

            // 2. Build the HTML report content
            let reportHTML = '';
            
            // Display vehicle info horizontally
            reportHTML += '<div class="vehicle-info-horizontal">';
            const vehicleFields = ['Vehicle Year', 'Vehicle Make', 'Vehicle Model', 'VIN'];
            vehicleFields.forEach(key => {
                reportHTML += `
                    <div class="report-item">
                        <span class="report-label">${key}:</span>
                        <span class="report-value">${fixedData[key]}</span>
                    </div>
                `;
            });
            reportHTML += '</div>';
            
            // Display service info horizontally
            reportHTML += '<div class="service-info-horizontal">';
            const serviceFields = ['Date of Service', 'Mileage / Hours'];
            serviceFields.forEach(key => {
                reportHTML += `
                    <div class="report-item">
                        <span class="report-label">${key}:</span>
                        <span class="report-value">${fixedData[key]}</span>
                    </div>
                `;
            });
            reportHTML += '</div>';
            
            // Display remaining fields vertically
            const remainingFields = ['Type of Service', 'Work Performed'];
            remainingFields.forEach(key => {
                reportHTML += `
                    <div class="report-item">
                        <span class="report-label">${key}:</span>
                        <span class="report-value">${fixedData[key]}</span>
                    </div>
                `;
            });
            
            reportHTML += `
                <div class="report-item" style="display:block;">
                    <span class="report-label">Parts Used:</span>
            `;
            
            if (parts.length > 0) {
                reportHTML += '<table class="report-parts-table">';
                reportHTML += `
                    <thead>
                        <tr>
                            <th class="qty-col">Qty</th>
                            <th>Part Name</th>
                            <th>Part #</th>
                            <th>Brand</th>
                            <th class="cost-col">Unit Cost</th>
                            <th class="cost-col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                parts.forEach(part => {
                    const partNumber = part.number || 'â€”';
                    const brand = part.brand || 'â€”';
                    const unitCost = part.cost > 0 ? `$${part.cost.toFixed(2)}` : 'â€”';
                    const lineTotal = part.cost > 0 ? `$${part.lineCost.toFixed(2)}` : 'â€”';
                    reportHTML += `
                        <tr>
                            <td class="qty-col">${part.quantity}</td>
                            <td>${part.name || 'â€”'}</td>
                            <td>${partNumber}</td>
                            <td>${brand}</td>
                            <td class="cost-col">${unitCost}</td>
                            <td class="cost-col">${lineTotal}</td>
                        </tr>
                    `;
                });
                reportHTML += '</tbody></table>';
                
                const salesTax = totalCost * 0.06;
                const totalWithTax = totalCost + salesTax;
                
                reportHTML += `
                    <div class="report-total-cost">
                        <div>Subtotal: <span>$${totalCost.toFixed(2)}</span></div>
                        <div>Sales Tax (6%): <span>$${salesTax.toFixed(2)}</span></div>
                        <div><strong>Total: $${totalWithTax.toFixed(2)}</strong></div>
                    </div>
                `;

            } else {
                reportHTML += '<span class="report-value" style="font-style: italic;">No specific parts listed.</span>';
            }

            reportHTML += '</div>';
            
            // Display next service due horizontally at the end
            reportHTML += '<div class="next-service-horizontal">';
            reportHTML += `
                <div class="report-item">
                    <span class="report-label">Next Service Due:</span>
                    <span class="report-value">${fixedData['Next Service Due']}</span>
                </div>
            `;
            reportHTML += '</div>';

            // 3. Update the DOM and print
            reportOutput.innerHTML = reportHTML;
            reportOutput.style.display = 'block'; 

            window.print();
        }

        function resetMaintenanceForm() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('reportOutput').style.display = 'none';
            
            const partsContainer = document.getElementById('partsContainer');
            partsContainer.innerHTML = '';
            addPartEntry(); 
            
            initializeForm(); 
        }

    </script>
</body>
</html>
